<?php

/**
 * Implementation of hook_feeds_plugins().
 */
function feeds_excel_feeds_plugins(){
  $info = array();
  $info['ExcelParser'] = array(
    'name' => 'Excel parser',
    'description' => 'Parses an excel file.',
    'handler' => array(
      'parent' => 'FeedsParser',
      'class' => 'FeedsExcelParser',
      'file' => 'ExcelParser.inc',
      'path' => drupal_get_path('module', 'feeds_excel')
    )
  );
  return $info;
}

/**
 * Debugging
 */
function feeds_excel_menu(){
  return array(
    'fe' => array(
      'title' => 'Feeds Excel',
      'page callback' => 'feeds_excel_test',
      'access arguments' => array(
        'access content'
      )
    )
  );
}

function feeds_excel_test(){
  $path = libraries_get_path('PHPExcel');
  //require_once($path . '/PHPExcel.php');
  require_once "$path/PHPExcel/IOFactory.php";
  $objPHPExcel = PHPExcel_IOFactory::load(drupal_get_path('module', 'feeds_excel') . '/import.xls');
  $output = '';
  foreach($objPHPExcel->getWorksheetIterator() as $worksheet){
    $output .= '- ' . $worksheet->getTitle() . "<br/>";
    foreach($worksheet->getRowIterator() as $row){
      $output .= '    - Row number: ' . $row->getRowIndex() . "<br/>";
      $cellIterator = $row->getCellIterator();
      $cellIterator->setIterateOnlyExistingCells(false); // Loop all cells, even if it is not set
      foreach($cellIterator as $cell){
        if(!is_null($cell)){
          $output .= '        - Cell: ' . $cell->getCoordinate() . ' - ' . $cell->getCalculatedValue() . "<br/>";
        }
      }
    }
  }
  return $output;
}