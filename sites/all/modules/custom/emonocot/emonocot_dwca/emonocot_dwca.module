<?php

/**
 * Implements hook_views_default_views_alter().
 * 
 * Replace uuid fields with wcm identifiers
 * 
 * @param $views
 */
function emonocot_dwca_views_default_views_alter(&$views){
  foreach($views as $view){
    //Is this a dwca_export view?
    if(substr($view->name, 0, 11) == 'dwca_export' && $view->name != 'dwca_export_eol_agents'){
      if(isset($view->display['default']->display_options['fields']['uuid'])){
        //Hide uuid field
        $view->display['default']->display_options['fields']['uuid']['exclude'] = TRUE;
        emonocot_dwca_add_wcm_field($view);
        //If a relationship is set on uuid field make same relatinship on wcm field
        if(isset($view->display['default']->display_options['fields']['uuid']['relationship'])){
          $view->display['default']->display_options['fields']['wcm_id']['relationship'] = $view->display['default']->display_options['fields']['uuid']['relationship'];
        }
      }
      //The classification dwca_export view has a parent taxonomy field, uuid_1
      if(isset($view->display['default']->display_options['fields']['uuid_1']) && $view->name == 'dwca_export_classification'){
        //Preserve the relationship
        $relationship = NULL;
        if(isset($view->display['default']->display_options['fields']['uuid_1']['relationship'])){
          $relationship = $view->display['default']->display_options['fields']['uuid_1']['relationship'];
        }
        $view->display['default']->display_options['fields']['uuid_1']['exclude'] = TRUE;
        emonocot_dwca_add_wcm_parent_field($view);
        if(!is_null($relationship)){
          $view->display['default']->display_options['fields']['wcm_id_1']['relationship'] = $relationship;
        }
        $view->display['default']->display_options['fields']['wcm_id_1']['label'] = 'Parent ID';
      }
    }
    
    //For description references change Rights field to associated Biblio nodes rights

    if (substr($view->name, 0, 23) == 'dwca_export_description'){
      $field_matching = array(
        'dwca_export_description_genera' => 'field_spm_em_gd_ref',
      );
      if (isset($field_matching[$view->name])){
      	$view->display['default']->display_options['fields']['nothing']['exclude'] = TRUE;
      	$view->display['default']->display_options['fields']['nothing_1']['exclude'] = TRUE;
      	$view->display['default']->display_options['fields']['path']['exclude'] = TRUE;
      	emonocot_dwca_add_description_fields($view, $field_matching[$view->name]);
      }
    }
  }
}


function emonocot_dwca_add_description_fields(&$view, $ref_field){
  $new_field = array();
  $new_field['id'] = 'field_emonocot_acknowledgement';
  $new_field['table'] = 'field_data_field_emonocot_acknowledgement';
  $new_field['field'] = 'field_emonocot_acknowledgement';
  $new_field['relationship'] = $ref_field;
  $new_field['label'] = 'Rights';
  $new_field['alter']['alter_text'] = 0;
  $new_field['alter']['make_link'] = 0;
  $new_field['alter']['absolute'] = 0;
  $new_field['alter']['external'] = 0;
  $new_field['alter']['replace_spaces'] = 0;
  $new_field['alter']['trim_whitespace'] = 0;
  $new_field['alter']['nl2br'] = 0;
  $new_field['alter']['word_boundary'] = 1;
  $new_field['alter']['ellipsis'] = 1;
  $new_field['alter']['more_link'] = 0;
  $new_field['alter']['strip_tags'] = 0;
  $new_field['alter']['trim'] = 0;
  $new_field['alter']['html'] = 0;
  $new_field['element_label_colon'] = 1;
  $new_field['element_default_classes'] = 1;
  $new_field['hide_empty'] = 0;
  $new_field['empty_zero'] = 0;
  $new_field['hide_alter_empty'] = 1;
  $new_field['field_api_classes'] = 0;
  $view->display['default']->display_options['fields']['field_emonocot_acknowledgement'] = $new_field;
  unset($new_field);

  $new_field = array();
  $new_field['id'] = 'path_2';
  $new_field['table'] = 'node';
  $new_field['field'] = 'path';
  $new_field['label'] = 'DC Reference';
  $new_field['alter']['alter_text'] = 0;
  $new_field['alter']['make_link'] = 0;
  $new_field['alter']['absolute'] = 0;
  $new_field['alter']['external'] = 0;
  $new_field['alter']['replace_spaces'] = 0;
  $new_field['alter']['trim_whitespace'] = 0;
  $new_field['alter']['nl2br'] = 0;
  $new_field['alter']['word_boundary'] = 1;
  $new_field['alter']['ellipsis'] = 1;
  $new_field['alter']['more_link'] = 0;
  $new_field['alter']['strip_tags'] = 0;
  $new_field['alter']['trim'] = 0;
  $new_field['alter']['html'] = 0;
  $new_field['element_label_colon'] = 1;
  $new_field['element_default_classes'] = 1;
  $new_field['hide_empty'] = 0;
  $new_field['empty_zero'] = 0;
  $new_field['hide_alter_empty'] = 1;
  $new_field['absolute'] = 1;
  $view->display['default']->display_options['fields']['path_2'] = $new_field;
  
  
  $new_field = array();
  $new_field['id'] = 'path_1';
  $new_field['table'] = 'node';
  $new_field['field'] = 'path';
  $new_field['relationship'] = 'field_spm_em_gd_ref';
  $new_field['label'] = 'DC Source';
  $new_field['alter']['alter_text'] = 0;
  $new_field['alter']['make_link'] = 0;
  $new_field['alter']['absolute'] = 0;
  $new_field['alter']['external'] = 0;
  $new_field['alter']['replace_spaces'] = 0;
  $new_field['alter']['trim_whitespace'] = 0;
  $new_field['alter']['nl2br'] = 0;
  $new_field['alter']['word_boundary'] = 1;
  $new_field['alter']['ellipsis'] = 1;
  $new_field['alter']['more_link'] = 0;
  $new_field['alter']['strip_tags'] = 0;
  $new_field['alter']['trim'] = 0;
  $new_field['alter']['html'] = 0;
  $new_field['element_label_colon'] = 1;
  $new_field['element_default_classes'] = 1;
  $new_field['hide_empty'] = 0;
  $new_field['empty_zero'] = 0;
  $new_field['hide_alter_empty'] = 1;
  $new_field['absolute'] = 1;
  $view->display['default']->display_options['fields']['path_1'] = $new_field;
  
  $new_relationship = array();
  $new_relationship['id'] = $ref_field.'_nid';
  $new_relationship['table'] = 'field_data_'.$ref_field;
  $new_relationship['field'] = $ref_field.'_nid';
  $new_relationship['required'] = 0;
  $new_relationship['delta'] = '-1';
  $view->display['default']->display_options['relationships'][$ref_field] = $new_relationship;
  
}


/**
 * 
 * Adds the WCM-ID field to the dwca_export view
 * 
 * @param $view
 */
function emonocot_dwca_add_wcm_field(&$view){
  $new_field = array();
  $new_field['id'] = 'wcm_id';
  $new_field['field'] = 'field_id';
  $new_field['table'] = 'field_data_field_id';
  $new_field['label'] = 'id';
  $new_field['alter']['alter_text'] = 0;
  $new_field['alter']['make_link'] = 0;
  $new_field['alter']['absolute'] = 0;
  $new_field['alter']['external'] = 0;
  $new_field['alter']['replace_spaces'] = 0;
  $new_field['alter']['trim_whitespace'] = 0;
  $new_field['alter']['nl2br'] = 0;
  $new_field['alter']['word_boundary'] = 1;
  $new_field['alter']['ellipsis'] = 1;
  $new_field['alter']['strip_tags'] = 0;
  $new_field['alter']['trim'] = 0;
  $new_field['alter']['html'] = 0;
  $new_field['element_label_colon'] = 1;
  $new_field['element_default_classes'] = 1;
  $new_field['hide_empty'] = 0;
  $new_field['empty_zero'] = 0;
  $new_field['hide_alter_empty'] = 0;
  $new_field['separator'] = '';
  $new_field['format_plural'] = 0;
  $new_field['field_api_classes'] = 0;
  if ($view->name == 'dwca_export_image'){
  	$new_field['exclude'] = TRUE;
  }
  //array_unshift($view->display['default']->display_options['fields'], $new_field);
  $view->display['default']->display_options['fields'] = array_reverse($view->display['default']->display_options['fields'], true);
  if ($view->name == 'dwca_export_image'){
  	$view->display['default']->display_options['fields']['wcm_id_2'] = emonocot_dwca_add_wcm_image($view);
  }
  $view->display['default']->display_options['fields']['wcm_id'] = $new_field;
  $view->display['default']->display_options['fields'] = array_reverse($view->display['default']->display_options['fields'], true);
}

/**
 * 
 * Adds the WCM-ID field of the parent term to the dwca_export view
 * 
 * @param $view
 */
function emonocot_dwca_add_wcm_parent_field(&$view){
  $new_field = array();
  $new_field['id'] = 'wcm_id_1';
  $new_field['field'] = 'field_id';
  $new_field['table'] = 'field_data_field_id';
  $new_field['label'] = 'id';
  $new_field['alter']['alter_text'] = 0;
  $new_field['alter']['make_link'] = 0;
  $new_field['alter']['absolute'] = 0;
  $new_field['alter']['external'] = 0;
  $new_field['alter']['replace_spaces'] = 0;
  $new_field['alter']['trim_whitespace'] = 0;
  $new_field['alter']['nl2br'] = 0;
  $new_field['alter']['word_boundary'] = 1;
  $new_field['alter']['ellipsis'] = 1;
  $new_field['alter']['strip_tags'] = 0;
  $new_field['alter']['trim'] = 0;
  $new_field['alter']['html'] = 0;
  $new_field['element_label_colon'] = 1;
  $new_field['element_default_classes'] = 1;
  $new_field['hide_empty'] = 0;
  $new_field['empty_zero'] = 0;
  $new_field['hide_alter_empty'] = 0;
  $new_field['separator'] = '';
  $new_field['format_plural'] = 0;
  $new_field['field_api_classes'] = 0;
  //array_unshift($view->display['default']->display_options['fields'], $new_field);
  $view->display['default']->display_options['fields']['wcm_id_1'] = $new_field;
}

function emonocot_dwca_add_wcm_image(&$view){
$new_field = array();
$new_field['id'] = 'field_id';
$new_field['table'] = 'field_data_field_id';
$new_field['field'] = 'field_id';
$new_field['relationship'] = 'field_taxonomic_name_tid_1';
$new_field['alter']['alter_text'] = 1;
$new_field['alter']['text'] = '[wcm_id]';
$new_field['alter']['make_link'] = 0;
$new_field['alter']['absolute'] = 0;
$new_field['alter']['external'] = 0;
$new_field['alter']['replace_spaces'] = 0;
$new_field['alter']['trim_whitespace'] = 0;
$new_field['alter']['nl2br'] = 0;
$new_field['alter']['word_boundary'] = 1;
$new_field['alter']['ellipsis'] = 1;
$new_field['alter']['more_link'] = 0;
$new_field['alter']['strip_tags'] = 0;
$new_field['alter']['trim'] = 0;
$new_field['alter']['html'] = 0;
$new_field['element_label_colon'] = 1;
$new_field['element_default_classes'] = 1;
$new_field['empty'] = '[wcm_id_2]';
$new_field['hide_empty'] = 0;
$new_field['empty_zero'] = 0;
$new_field['hide_alter_empty'] = 1;
$new_field['field_api_classes'] = 0;
return $new_field;
}