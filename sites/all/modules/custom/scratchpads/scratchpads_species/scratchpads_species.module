<?php

/*********************************************************************************************
 * 
 * HOOKS
 * 
 ********************************************************************************************/
/**
 * Implements hook_menu().
 */
function scratchpads_species_menu(){
  $weight = 1;
  foreach(scratchpads_species_get_tabs() as $tab => $label){
    $items['taxonomy/term/%taxonomy_term/' . $tab] = array(
      'title' => $label,
      'page callback' => 'scratchpads_species_term_page',
      'page arguments' => array(
        2,
        3
      ),
      'access callback' => 'scratchpads_species_access_callback',
      'access arguments' => array(
        2
      ),
      'type' => MENU_LOCAL_TASK,
      'weight' => $weight++,
      'file' => 'taxonomy.pages.inc',
      'file path' => drupal_get_path('module', 'taxonomy')
    );
  }
  // Add the empty content toggle
  $items['taxonomy/term/%taxonomy_term/toggle-empty-blocks'] = array(
    'title' => 'Toggle empty blocks',
    'page callback' => 'scratchpads_species_toggle_empty_blocks',
    'page arguments' => array(
      2
    ),
    'access arguments' => array(
      'toggle empty blocks'
    ),
    'weight' => 10,
    'type' => MENU_LOCAL_TASK,
    'context' => MENU_CONTEXT_INLINE
  );
  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function scratchpads_species_menu_alter(&$items){
  $items['taxonomy/term/%taxonomy_term/view']['title callback'] = 'scratchpads_species_title_callback';
  $items['taxonomy/term/%taxonomy_term/view']['title arguments'] = array(
    2
  );
  $items['taxonomy/term/%taxonomy_term']['page callback'] = 'scratchpads_species_term_page';
  $items['taxonomy/term/%taxonomy_term/edit']['context'] = MENU_CONTEXT_INLINE;
  if(array_key_exists('taxonomy/term/%taxonomy_term/devel', $items)){
    $items['taxonomy/term/%taxonomy_term/devel']['context'] = MENU_CONTEXT_INLINE;
  }
}

/**
 * Implementation of hook_permission().
 */
function scratchpads_species_permission(){
  return array(
    'toggle empty blocks' => array(
      'title' => t('toggle empty blocks'),
      'description' => t('Allows user to turn on & off empty blocks.')
    )
  );
}

/**
 * Implementation of hook_form_alter().
 */
function scratchpads_species_form_node_type_form_alter(&$form, &$form_state){
  $type = $form['#node_type']->type;
  $form_state['var'] = 'species_page_' . $type . '_tab';
  $tab = variable_get($form_state['var'], NULL);
  $form['display']['species_page_display'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display on species pages.'),
    '#default_value' => ($tab ? 1 : 0),
    '#description' => t('Do you want to display this content on the species page?')
  );
  $tabs = scratchpads_species_get_tabs();
  if(isset($tabs[$type])){
    unset($tabs[$type]);
  }
  $form['display']['tabs'] = array(
    '#type' => 'radios',
    '#title' => t('Tabs'),
    '#default_value' => $tab,
    '#options' => array_merge(array(
      'own' => t('Own tab')
    ), $tabs),
    '#description' => t('In which tab on the species pages do you want to display this content type?'),
    '#states' => array(
      'invisible' => array(
        'input[name="species_page_display"]' => array(
          'checked' => FALSE
        )
      )
    )
  );
  $form['#validate'][] = 'scratchpads_species_node_type_form_validate';
  $form['#submit'][] = 'scratchpads_species_node_type_form_submit';
}

function scratchpads_species_node_type_form_submit($form, $form_state){
  if($form_state['values']['species_page_display'] && !empty($form_state['values']['tabs'])){
    variable_set($form_state['var'], $form_state['values']['tabs']);
  }else{
    variable_del($form_state['var']);
  }
}

function scratchpads_species_node_type_form_validate($form, $form_state){
  if($form_state['values']['species_page_display'] && empty($form_state['values']['tabs'])){
    form_set_error('tabs', t("Please select where on the species page you want this content type to display."));
  }
}

/*********************************************************************************************
 * 
 * MENU CALLBACKS
 * 
 ********************************************************************************************/
function scratchpads_species_title_callback($term){
  if(scratchpads_species_term_is_biological_classification($term)){
    return t("Overview");
  }else{
    return t("View");
  }
}

function scratchpads_species_access_callback($term){
  if(scratchpads_species_term_is_biological_classification($term)){
    return user_access('access content');
  }else{
    return false;
  }
}

function scratchpads_species_term_page($term, $op = 'overview'){
  if(scratchpads_species_term_is_biological_classification($term)){
    $path = drupal_get_path('module', 'scratchpads_species');
    drupal_add_css($path . '/css/scratchpads_species.css');
    // Copied from context_entity_prepare_view()
    // Trigger the taxonomy viewing condition 
    if($plugin = context_get_plugin('condition', 'taxonomy_term')){
      $plugin->execute($term, 'view');
    }
    // Trigger the species tab condition
    if($plugin = context_get_plugin('condition', 'species')){
      $plugin->execute($op);
    }
    // Return a blank page contextual links
    $build = array(
      '#theme' => 'page',
      '#type' => 'page',
      'content' => array(
        ''
      ),
      'subtitle' => (isset($term->field_authors[LANGUAGE_NONE][0]['safe_value']) ? $term->field_authors[LANGUAGE_NONE][0]['safe_value'] : NULL),
      '#contextual_links' => array(
        'taxonomy' => array(
          'taxonomy',
          array(
            'term',
            $term->tid
          )
        )
      )
    );
  }else{
    $build = taxonomy_term_page($term);
  }
  return $build;
}

function scratchpads_species_toggle_empty_blocks($term){
  drupal_set_message(t('You have turned on empty blocks on the species pages.'));
  // Return to the original page
  drupal_goto(drupal_get_destination());
}

/*********************************************************************************************
 * 
 * VIEWS
 * 
 ********************************************************************************************/
/**
 * Implementation of hook_views_api
 */
function scratchpads_species_views_api(){
  $path = drupal_get_path('module', 'scratchpads_species');
  return array(
    'api' => '3',
    'path' => $path . '/views'
  );
}

function scratchpads_species_theme(){
  return array(
    'scratchpads_species_name' => array(
      'variables' => array(
        'term' => NULL
      )
    )
  );
}

function scratchpads_species_preprocess_views_view_field(&$vars){
  if($vars['view']->name == 'species_nomenclature'){
    if($vars['field']->table == 'taxonomy_term_data' && $vars['field']->field == 'name'){
      $name = $vars['row']->{$vars['field']->field_alias};
      $tid = $vars['field']->aliases['tid'];
      $term = taxonomy_term_load($vars['row']->{$tid});
      $formatted_name = theme('scratchpads_species_name', array(
        'term' => $term
      ));
      $vars['output'] = str_replace($name, $formatted_name, $vars['output']);
    }
  }
}

function theme_scratchpads_species_name($vars){
  $term = $vars['term'];
  // TODO- A whole load of crapness for species names
  $name = $term->name;
  switch($term->field_rank[LANGUAGE_NONE][0]['value']){
    case 'Genus':
    case 'Subgenus':
    case 'Species':
    case 'Subspecies':
      $italicise = true;
      break;
  }
  $italicise = true;
  if($italicise){
    $name = '<em>' . $name . '</em>';
  }
  return $name;
}

/*********************************************************************************************
 * 
 * CONTEXT
 * 
 ********************************************************************************************/
/**
 * Implementation of hook_ctools_plugin_type().
 */
function scratchpads_species_ctools_plugin_type(){
  return array(
    'plugins' => array(
      'cache' => TRUE,
      'use hooks' => TRUE,
      'classes' => array(
        'handler'
      )
    )
  );
}

/**
 * Implementation of hook_ctools_plugin_api().
 */
function scratchpads_species_ctools_plugin_api(){
  list($module, $api) = func_get_args();
  if($module == "context" && $api == "context"){return array(
      "version" => "3"
    );}
}

/**
 * CTools plugin API hook for Context. Note that a proper entry in
 * hook_ctools_plugin_api() must exist for this hook to be called.
 */
function scratchpads_species_context_plugins(){
  $plugins = array();
  $plugins['scratchpads_species_context_condition'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'scratchpads_species') . '/plugins',
      'file' => 'scratchpads_species_context_condition.inc',
      'class' => 'scratchpads_species_context_condition',
      'parent' => 'context_condition'
    )
  );
  return $plugins;
}

/**
 * Implementation of hook_context_registry().
 * Register the context plugins
 */
function scratchpads_species_context_registry(){
  return array(
    'conditions' => array(
      'species' => array(
        'title' => t('Species page'),
        'plugin' => 'scratchpads_species_context_condition'
      )
    )
  );
}

/*********************************************************************************************
 * 
 * MODULE FUNCTIONS
 * 
 ********************************************************************************************/
/**
 * Check if a term is a biological classification
 */
function scratchpads_species_term_is_biological_classification($term){
  global $conf;
  if(property_exists($term, 'field_unit_name1')){
    if(array_key_exists($term->vid, $conf['biological_vids'])){return true;}
  }
  return false;
}

/**
 * Return a list of node types to display on the species page
 */
function scratchpads_species_get_node_tabs(){
  $node_types = array();
  $node_info = node_type_get_names();
  foreach(array_keys($node_info) as $type){
    if(variable_get('species_page_' . $type . '_tab', NULL) == 'own'){
      $node_types[$type] = $node_info[$type];
    }
  }
  return $node_types;
}

/**
 * Return a list of default species tabs
 */
function scratchpads_species_get_default_tabs(){
  $tabs = array(
    'descriptions' => t('Descriptions'),
    'media' => t('Media'),
    'literature' => t('Literature'),
    'maps' => t('Maps'),
    'specimens' => t('Specimens'),
    'phylogeny' => t('Phylogeny')
  );
  return $tabs;
}

/**
 * Return a list of species tabs
 */
function scratchpads_species_get_tabs(){
  return array_merge(scratchpads_species_get_default_tabs(), scratchpads_species_get_node_tabs());
}

function scratchpads_species_get_context_blocks($context){
  module_load_include('inc', 'scratchpads_species', 'views/scratchpads_species.views_default');
  $blocks = array();
  foreach(scratchpads_species_views_default_views() as $view){
    if(!empty($view->context)){
      if($view->context == $context){
        $blocks[] = $view->name . '-block';
      }
    }
  }
  return $blocks;
}

/*********************************************************************************************
 * 
 * IMAGE STYLES
 * 
 ********************************************************************************************/
/**
 * Implementation of hook_styles_default_styles().
 */
function scratchpads_species_styles_default_styles(){
  $styles = array();
  // Exported style: species_slideshow_large
  $styles['file']['styles']['species_slideshow_large'] = array(
    'label' => 'species_slideshow_large',
    'description' => '',
    'preset_info' => array(
      'image' => array(
        'species_slideshow_large' => array(
          'default preset' => 'original',
          'preset' => 'species_slideshow_large'
        )
      ),
      'default' => array(
        'species_slideshow_large' => array(
          'default preset' => 'original'
        )
      )
    )
  );
  // Exported style: species_slideshow_thumbnail
  $styles['file']['styles']['species_slideshow_thumbnail'] = array(
    'label' => 'species_slideshow_thumbnail',
    'description' => '',
    'preset_info' => array(
      'image' => array(
        'species_slideshow_thumbnail' => array(
          'default preset' => 'original',
          'preset' => 'species_slideshow_thumbnail'
        )
      ),
      'default' => array(
        'species_slideshow_thumbnail' => array(
          'default preset' => 'original'
        )
      )
    )
  );
  return $styles;
}

/**
 * Implements hook_styles_default_presets_alter().
 */
function scratchpads_species_styles_default_presets_alter(&$presets){
  $styles = styles_default_styles();
  if($styles['file']['styles']['species_slideshow_large']['storage'] == STYLES_STORAGE_DEFAULT){
    $presets['file']['containers']['image']['styles']['species_slideshow_large'] = array(
      'default preset' => 'original',
      'preset' => 'species_slideshow_large'
    );
    $presets['file']['containers']['audio']['styles']['species_slideshow_large'] = array(
      'default preset' => 'original'
    );
    $presets['file']['containers']['video']['styles']['species_slideshow_large'] = array(
      'default preset' => 'original'
    );
    $presets['file']['containers']['default']['styles']['species_slideshow_large'] = array(
      'default preset' => 'original'
    );
  }
  if($styles['file']['styles']['species_slideshow_thumbnail']['storage'] == STYLES_STORAGE_DEFAULT){
    $presets['file']['containers']['image']['styles']['species_slideshow_thumbnail'] = array(
      'default preset' => 'original',
      'preset' => 'species_slideshow_thumbnail'
    );
    $presets['file']['containers']['audio']['styles']['species_slideshow_thumbnail'] = array(
      'default preset' => 'original'
    );
    $presets['file']['containers']['video']['styles']['species_slideshow_thumbnail'] = array(
      'default preset' => 'original'
    );
    $presets['file']['containers']['default']['styles']['species_slideshow_thumbnail'] = array(
      'default preset' => 'original'
    );
  }
}

/**
 * Implementation of hook_image_default_styles().
 */
function scratchpads_species_image_default_styles(){
  $styles = array();
  // Exported image style: species_slideshow_large
  $styles['species_slideshow_large'] = array(
    'name' => 'species_slideshow_large',
    'effects' => array(
      2 => array(
        'label' => 'Scale and crop',
        'help' => 'Scale and crop will maintain the aspect-ratio of the original image, then crop the larger dimension. This is most useful for creating perfectly square thumbnails without stretching the image.',
        'effect callback' => 'image_scale_and_crop_effect',
        'dimensions callback' => 'image_resize_dimensions',
        'form callback' => 'image_resize_form',
        'summary theme' => 'image_resize_summary',
        'module' => 'image',
        'name' => 'image_scale_and_crop',
        'data' => array(
          'width' => '284',
          'height' => '211'
        ),
        'weight' => '1'
      )
    )
  );
  // Exported image style: species_slideshow_thumbnail
  $styles['species_slideshow_thumbnail'] = array(
    'name' => 'species_slideshow_thumbnail',
    'effects' => array(
      1 => array(
        'label' => 'Scale and crop',
        'help' => 'Scale and crop will maintain the aspect-ratio of the original image, then crop the larger dimension. This is most useful for creating perfectly square thumbnails without stretching the image.',
        'effect callback' => 'image_scale_and_crop_effect',
        'dimensions callback' => 'image_resize_dimensions',
        'form callback' => 'image_resize_form',
        'summary theme' => 'image_resize_summary',
        'module' => 'image',
        'name' => 'image_scale_and_crop',
        'data' => array(
          'width' => '92',
          'height' => '69'
        ),
        'weight' => '1'
      )
    )
  );
  return $styles;
}


