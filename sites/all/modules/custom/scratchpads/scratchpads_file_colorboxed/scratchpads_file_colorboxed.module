<?php
include_once ('scratchpads_file_colorboxed.features.inc');

/**
 * Implementation of hook_menu()
 */
function scratchpads_file_colorboxed_menu(){
  return array(
    'file-colorboxed/%' => array(
      'title' => 'Scratchpads colorbox',
      'page callback' => 'scratchpads_file_colorboxed_entity_simple_view',
      'page arguments' => array(
        1
      ),
      'access callback' => 'file_entity_access',
      'access arguments' => array(
        'view'
      )
    )
  );
}

/**
 * Callback for the above menu entry.
 */
function scratchpads_file_colorboxed_entity_simple_view($fid){
  // Check first to see if this file is associated with an eolapi entity.  If it
  // is, we display that instead.
  if(module_exists('eolapi') && db_table_exists('field_data_eolapi_image')){
    $results = db_select('field_data_eolapi_image', 'f')->fields('f', array(
      'entity_id'
    ))->condition('eolapi_image_fid', $fid)->execute();
    foreach($results as $row){
      $eolapi = eolapi_load($row->entity_id);
      $markup = eolapi_page_view($eolapi);
      echo drupal_render($markup);
      exit();
    }
  }
  $entity = entity_load_single('file', $fid);
  $view_type = 'file_styles_colorbox';
  // Wrap the audio file specially.
  if($entity->type == 'audio'){
    $width = 'width:400px;';
  }else{
    $width = '';
  }
  // Only use the colorbox display type if we're viewing certain files.
  if(!in_array($entity->type, array(
    'image',
    'video',
    'audio'
  ))){
    $view_type = 'default';
  }
  $content = entity_view('file', array(
    $entity
  ), $view_type);
  $image_links = '';
  if($entity->type == 'image'){
    $image_user = user_load($entity->uid);
    $image_links = '<p>' . l(t('Download the original'), file_create_url($entity->uri), array(
      'attributes' => array(
        'target' => '_blank'
      )
    )) . ' ' . t('uploaded by:') . ' ' . l($image_user->name, 'user/' . $image_user->uid) . '</p>';
  }
  echo '<div style="' . $width . 'padding:10px">' . drupal_render($content) . $image_links . '</div>';
  exit();
}