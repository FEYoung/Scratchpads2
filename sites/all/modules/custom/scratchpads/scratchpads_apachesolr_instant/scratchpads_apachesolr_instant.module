<?php

/**
 * Implementation of hook_entity_insert().
 */
function scratchpads_apachesolr_instant_entity_insert($entity, $type){
  // If this is a biological classification & there is a menu item for it, rebuild the menu to check it's still useful
  $shutdown_registered = &drupal_static(__FUNCTION__);
  if(!$shutdown_registered){
    $shutdown_registered = 1;
    drupal_register_shutdown_function('scratchpads_apachesolr_instant_shutdown');
  }else{
    $shutdown_registered++;
  }
}

/**
 * Implementation of hook_entity_delete().
 */
function scratchpads_apachesolr_instant_entity_delete($entity, $type){
  scratchpads_apachesolr_instant_entity_insert($entity, $type);
}

/**
 * Implementation of hook_entity_insert().
 */
function scratchpads_apachesolr_instant_entity_update($entity, $type){
  scratchpads_apachesolr_instant_entity_insert($entity, $type);
}

/**
 * Shutdown function called by the entity insert or entity update.
 */
function scratchpads_apachesolr_instant_shutdown(){
  _scratchpads_apachesolr_instant_reset_limit(drupal_static('scratchpads_apachesolr_instant_entity_insert'));
  apachesolr_cron();
  _scratchpads_apachesolr_instant_reset_limit();
}

/**
 * Implementation of hook_cron
 *
 * Ensure that apachesolr_cron_limit is reset in case the indexing
 * in instant_shutdown failed
 */
function scratchpads_apachesolr_instant_cron(){
  _scratchpads_apachesolr_instant_reset_limit();
}

/**
 * function _scratchpads_apachesolr_instant_reset_limit
 *
 * Sets the apachesolr_cron_limit variable to a given value,
 * or restore it to the value it had the first time this function
 * was called.
 */
function _scratchpads_apachesolr_instant_reset_limit($limit = 0){
  if($limit == 0){
    $previous_limit = variable_get('scratchpads_apachesolr_instant_limit', 0);
    if($previous_limit != 0){
      variable_set('scratchpads_apachesolr_instant_limit', 0);
      variable_set('apachesolr_cron_limit', $previous_limit);
    }
  }else{
    $previous_limit = variable_get('apachesolr_cron_limit', 50);
    $old_limit = variable_get('scratchpads_apachesolr_instant_limit', 0);
    if($old_limit == 0){
      variable_set('scratchpads_apachesolr_instant_limit', $previous_limit);
    }
    variable_set('apachesolr_cron_limit', $limit);
  }
}
