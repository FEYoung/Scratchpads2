<?php

/**
 * Implements hook_menu()
 */
function anymals_login_menu(){
  return array(
    'anymals/login' => array(
      'title' => 'Log in',
      'description' => 'A basic login page to allow anymals+plants login',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'user_login'
      ),
      'delivery callback' => 'anymals_login_deliver_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK
    ),
    'anymals' => array(
      'title' => 'anymals+plants',
      'description' => 'Introduction and welcome page for the anymals+plants app.',
      'page callback' => 'anymals_login_welcome_page',
      'access callback' => TRUE,
      'delivery callback' => 'anymals_login_deliver_page',
      'type' => MENU_CALLBACK
    )
  );
}

/**
 * Implements hook_init()
 */
function anymals_login_init(){
  global $user;
  if($user->uid && $_GET['q'] == 'anymals/login'){
    drupal_goto('anymals');
  }
}

/**
 * Callback to display the "/anymals" page.
 */
function anymals_login_welcome_page(){
  return array(
    'message' => array(
      '#markup' => '<p>' . t('You are logged in to this Scratchpad, and we have a record of your anymals+plants client ID.') . '</p>'
    )
  );
}

/**
 * Implements hook_user_load()
 */
function anymals_login_user_load($users){
  $results = db_select('anymals_client_ids', 'a')->fields('a')->condition('uid', array_keys($users))->execute();
  foreach($results as $row){
    if(!isset($users[$row->uid]->anymals_client_id)){
      $users[$row->uid]->anymals_client_ids = array();
    }
    $users[$row->uid]->anymals_client_ids[] = $row->client_id;
  }
}

/**
 * Deliver a basic page without any additional theme shit.
 */
function anymals_login_deliver_page($page_callback_result){
  // We render the output first so that "#attached" js and css are added to the
  // relevant arrays.
  $output = drupal_render($page_callback_result);
  print '<!DOCTYPE html>
<html>
  <head>
    <title>' . drupal_get_title() . '</title>
    <style type="text/css" media="all">@import url("' . file_create_url(drupal_get_path('module', 'anymals_login') . '/css/login_page.css') . '");</style>
    ' . drupal_get_css() . '
    ' . drupal_get_js() . '
    <meta http-equiv="X-UA-Compatible" content="IE=100">
    <meta name="cursor-event-mode" value="native">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="width">
    <meta name="touch-event-mode" value="native">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  </head>
  <body>
    <div id="anymals-header" style="background-color: #' . variable_get('scratchpads_colour', SCRATCHPADS_DEFAULT_COLOUR) . '"><h1>' . check_plain(variable_get('site_name', 'Drupal')) . '</h1></div>
    <div id="anymals-content">' . $output . '</div>
  </body>
</html>';
}

/**
 * Submit function
 */
function anymals_login_user_login_form_submit(&$form, &$form_state){
  $form_state['redirect'] = 'anymals';
}

/**
 * Implements hook_form_FORM_ID_alter()
 */
function anymals_login_form_user_login_alter(&$form, &$form_state){
  $form['#submit'][] = 'anymals_login_user_login_form_submit';
}