<?php

/**
 * Implements hook_menu()
 */
function anymals_login_menu(){
  return array(
    'anymals/login' => array(
      'title' => 'Log in',
      'description' => 'A basic login page to allow anymals+plants login',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'user_login'
      ),
      'delivery callback' => 'anymals_login_deliver_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK
    ),
    'login/success' => array(
      'title' => 'anymals+plants',
      'description' => 'Introduction and welcome page for the anymals+plants app.',
      'page callback' => 'anymals_login_welcome_page',
      'access callback' => TRUE,
      'delivery callback' => 'anymals_login_deliver_page',
      'type' => MENU_CALLBACK
    ),
    'anymals' => array(
      'title' => 'anymals+plants',
      'description' => 'Redirect page which will take a user to either login/success or anymals/login',
      'page callback' => 'anymals_login_redirect_page',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK
    )
  );
}

/**
 * Callback to display the "/anymals" page which simply redirects to
 * login/success or anymals/login
 */
function anymals_login_redirect_page(){
  global $user;
  if($user->uid){
    anymals_login_add_client_id($_GET['clientid']);
    drupal_goto('login/success');
  }else{
    drupal_goto('anymals/login', array(
      'query' => array(
        'clientid' => $_GET['clientid']
      )
    ));
  }
}

/**
 * Simple function to add a client id to a user
 */
function anymals_login_add_client_id($clientid, $account = FALSE){
  if($clientid){
    if(!$account){
      global $user;
      $account = $user;
    }
    db_merge('anymals_client_ids')->key(array(
      'uid' => $user->uid,
      'client_id' => $clientid
    ))->fields(array(
      'uid' => $user->uid,
      'client_id' => $clientid
    ))->execute();
    // If the anymals module is enabled (it is possible that it's not), then we
    // execute its cron function
    if(function_exists('anymals_cron')){
      anymals_cron();
    }
    // We add this user to the group.
    $response = drupal_http_request('https://www.anymals.org/intercom/?request=addClients', array(
      'method' => 'POST',
      'data' => http_build_query(array(
        'key' => variable_get('anymals_key', ''),
        'token' => variable_get('anymals_token', ''),
        'clientid' => $clientid
      ))
    ));
    watchdog('anymals', 'Response from anymals+plants server: !response', array(
      '!response' => print_r($response, 1)
    ));
  }
}

/**
 * Callback to display the "/anymals" page.
 */
function anymals_login_welcome_page(){
  global $user;
  if($user->uid){
    return array(
      'message' => array(
        '#markup' => '<p>' . t('You are logged in to this Scratchpad, and we have a record of your anymals+plants client ID.') . '</p>'
      )
    );
  }else{
    drupal_goto('anymals/login');
  }
}

/**
 * Implements hook_user_load()
 */
function anymals_login_user_load($users){
  $results = db_select('anymals_client_ids', 'a')->fields('a')->condition('uid', array_keys($users))->execute();
  foreach($results as $row){
    if(!isset($users[$row->uid]->anymals_client_id)){
      $users[$row->uid]->anymals_client_ids = array();
    }
    $users[$row->uid]->anymals_client_ids[$row->client_id] = $row->client_id;
  }
}

/**
 * Implements hook_user_delete()
 */
function anymals_login_user_delete($account){
  // Get the clientid so that we can request the delete, and then delete the
  // entry from the table.
  if($account->anymals_client_ids){
    foreach($account->anymals_client_ids as $clientid){
      $response = drupal_http_request('https://www.anymals.org/intercom/?request=removeClients', array(
        'method' => 'POST',
        'data' => http_build_query(array(
          'key' => variable_get('anymals_key', ''),
          'token' => variable_get('anymals_token', ''),
          'clientid' => $clientid
        ))
      ));
      watchdog('anymals', 'Response from anymals+plants server: !response', array(
        '!response' => print_r($response, 1)
      ));
    }
    db_delete('anymals_client_ids')->condition('uid', $account->uid)->execute();
  }
}

/**
 * Deliver a basic page without any additional theme shit.
 */
function anymals_login_deliver_page($page_callback_result){
  // We render the output first so that "#attached" js and css are added to the
  // relevant arrays.
  $output = drupal_render($page_callback_result);
  print '<!DOCTYPE html>
<html>
  <head>
    <title>' . drupal_get_title() . '</title>
    <style type="text/css" media="all">@import url("' . file_create_url(drupal_get_path('module', 'anymals_login') . '/css/login_page.css') . '");</style>
    ' . drupal_get_css() . '
    ' . drupal_get_js() . '
    <meta http-equiv="X-UA-Compatible" content="IE=100">
    <meta name="cursor-event-mode" value="native">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="width">
    <meta name="touch-event-mode" value="native">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  </head>
  <body>
    <div id="anymals-header" style="background-color: #' . variable_get('scratchpads_colour', SCRATCHPADS_DEFAULT_COLOUR) . '"><h1>' . check_plain(variable_get('site_name', 'Drupal')) . '</h1></div>
    <div id="anymals-content">' . $output . '</div>
  </body>
</html>';
}

/**
 * Implements hook_module_implements_alter()
 */
function anymals_login_module_implements_alter(&$implementations, $hook){
  if(($hook == 'form_alter' || $hook == 'form_user_login_alter') && isset($implementations['anymals_login'])){
    $group = $implementations['anymals_login'];
    unset($implementations['anymals_login']);
    $implementations['anymals_login'] = $group;
  }
}

/**
 * Submit function
 */
function anymals_login_user_login_form_submit(&$form, &$form_state){
  $form_state['redirect'] = array(
    'anymals',
    array(
      'query' => array(
        'clientid' => $_GET['clientid']
      )
    )
  );
}

/**
 * Implements hook_form_FORM_ID_alter()
 */
function anymals_login_form_user_login_alter(&$form, &$form_state){
  $form['#submit'][] = 'anymals_login_user_login_form_submit';
}