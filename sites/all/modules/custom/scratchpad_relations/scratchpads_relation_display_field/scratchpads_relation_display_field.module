<?php

/**
 * Implements hook_field_formatter_info().
 */
function scratchpads_relation_display_field_field_formatter_info(){
  return array(
    'scratchpad_relation_default' => array(
      'label' => t('Default2'),
      'field types' => array(
        'relation_add'
      )
    ),
    'scratchpad_relation_otherendpoint' => array(
      'label' => t('Other endpoint2'),
      'field types' => array(
        'relation_add'
      )
    ),
    'scratchpad_relation_otherendpoint_label' => array(
      'label' => t('Other endpoint with label2'),
      'field types' => array(
        'relation_add'
      )
    ),
    'scratchpad_relation_add_endpoints_and_fields' => array(
      'label' => t('Endpoints and all fields2'),
      'field types' => array(
        'relation_add'
      )
    )
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function scratchpads_relation_display_field_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display){
  $element = array();
  list($entity_id) = entity_extract_ids($entity_type, $entity);
  switch($display['type']){
    case 'scratchpad_relation_default':
    case 'scratchpad_relation_otherendpoint':
    case 'scratchpad_relation_otherendpoint_label':
      foreach($items as $delta => $item){
        $links = array();
        list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
        $relation = (object)$item;
        $relation_type = relation_type_load($relation->relation_type);
        $label = $relation_type->directional ? $relation_type->reverse_label : $relation_type->label;
        $label = camelCaseToLabel($label);
        $duplicate = FALSE; // To make sure duplicates of $entity get included in object list.
        foreach(array_filter($relation->endpoints[LANGUAGE_NONE]) as $endpoint){
          if($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $id && $duplicate == FALSE){
            $duplicate = TRUE;
            // Use the forward label as sentence predicate if r_index == 0.
            // (only makes a difference if relation is directional).
            if($endpoint['r_index'] == 0){
              $label = camelCaseToLabel($relation_type->label);
              $label = ' ' . $label;
            }
          }else{
            $related_entities = entity_load($endpoint['entity_type'], array(
              $endpoint['entity_id']
            ));
            $related_entity = reset($related_entities);
            if($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $entity_id){
              if($display['type'] == 'scratchpad_relation_otherendpoint' || $display['type'] == 'scratchpad_relation_otherendpoint_label'){
                continue;
              }
              $link = array();
            }else{
              $link = entity_uri($endpoint['entity_type'], $related_entity);
              $link['href'] = $link['path'];
            }
            $link['title'] = entity_label($endpoint['entity_type'], $related_entity);
            $links[] = $link;
          }
        }
        $uri = entity_uri('relation', $relation);
        $relation_link = l(t('Relation @rid', array(
          '@rid' => $relation->rid
        )), $uri['path'], $uri['options']);
        if($display['type'] == 'scratchpad_relation_default'){
          // Can't use #heading as it's mercilessly check_plain'd.
          $element[$delta]['relation']['heading']['#markup'] = t('<h4>Part of !link</h4>', array(
            '!link' => $relation_link
          ));
        }
        if($display['type'] == 'scratchpad_relation_otherendpoint_label'){
          $endpoint_title = '';
          switch($instance['widget']['settings']['relation_endpoint_label']){
            case 'endpoint':
              $endpoint_title = t(check_plain($label));
              break;
            case 'custom':
              $endpoint_title = t($instance['widget']['settings']['relation_endpoint_custom_label']);
              break;
          }
          $endpoint_title .= $instance['widget']['settings']['relation_endpoint_label_delta'] ? ' ' . ($delta + 1) : ' ';
          $element[$delta]['relation']['heading']['#markup'] = t(check_plain($endpoint_title));
        }
        // We probably need to make this more customisable.
        if($display['type'] == 'scratchpad_relation_default' || count($links) > 1){
          $element[$delta]['relation']['links'] = array(
            '#theme' => 'links',
            '#links' => $links
          );
        }else{
          $element[$delta]['relation']['link'] = array(
            '#theme' => 'link',
            '#path' => $links[0]['href'],
            '#text' => $links[0]['title'],
            '#options' => array(
              'attributes' => array(),
              'html' => FALSE
            )
          );
        }
      }
      break;
    case 'scratchpad_relation_add_endpoints_and_fields':
      foreach($items as $delta => $item){
        $links = array();
        list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
        $relation = (object)$item;
        $relation_type = relation_type_load($relation->relation_type);
        $label = $relation_type->directional ? $relation_type->reverse_label : $relation_type->label;
        $label = camelCaseToLabel($label);
        if($display['label'] == 'inline'){
          $label_display = ' field-label-inline ';
        }else if($display['label'] == 'above'){
          $label_display = ' field-label-above ';
        }else if($display['label'] == 'hidden'){
          $label_display = ' field-label-inline ';
        }else{
          $label_display = '';
        }
        $duplicate = FALSE; // To make sure duplicates of $entity get included in object list.
        if(count($relation->endpoints[LANGUAGE_NONE]) > 1){
          foreach(array_filter($relation->endpoints[LANGUAGE_NONE]) as $endpoint){
            $element[$delta]['relation']['space']['#markup'] = "<br/>";
            if($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $id && $duplicate == FALSE){
              $duplicate = TRUE;
              // Use the forward label as sentence predicate if r_index == 0.
              // (only makes a difference if relation is directional).
              if($endpoint['r_index'] == 0){
                $label = camelCaseToLabel($relation_type->label);
                $label = ' ' . $label;
              }
            }else{
              $related_entities = entity_load($endpoint['entity_type'], array(
                $endpoint['entity_id']
              ));
              $related_entity = reset($related_entities);
              if(!($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $entity_id)){
                $link = entity_uri($endpoint['entity_type'], $related_entity);
                $link['href'] = $link['path'];
                $link['title'] = entity_label($endpoint['entity_type'], $related_entity);
                $relation_link = l($link['title'], $link['href']);
                $element[$delta]['relation']['relation'] = array(
                  'item' => array(
                    '#type' => 'container',
                    '#attributes' => array(
                      'class' => array(
                        'field field-name-field-endpoint' . $label_display . 'clearfix'
                      )
                    ),
                    'markup' => array(
                      '#markup' => $label . ' ' . $relation_link
                    )
                  )
                );
              }
            }
          }
        }
        $relation_view = relation_view($relation);
        $relation_instances = field_info_instances('relation', $relation->relation_type);
        foreach(array_keys($relation_instances) as $relation_field_name){
          if($relation_field_name !== 'endpoints'){
            if(isset($relation_view[$relation_field_name])){
              //print '<pre>' . print_r($relation_view[$relation_field_name], TRUE) . '</pre>';
              $element[$delta]['relation']['fields'][] = $relation_view[$relation_field_name];
            }
          }
        }
      }
      break;
  }
  return $element;
}

/**
 * Implements hook_field_prepare_view().
 */
function scratchpads_relation_display_field_field_prepare_view($entity_type, $entities, $field, $instances, $langcode, &$items, $displays){
  foreach($entities as $id => $entity){
    $relation_types = $instances[$id]['settings']['relation_type'];
    $query = relation_query($entity_type, $id)->range(0, 50);
    if($relation_types){
      // TODO:SINGLE_DIR: Fails in cases where we want directional relations for
      // which the entity is only the source, but not the target, or vice versa.
      // But to do this properly would mean multiple queries (up to 3).
      $query->entityCondition('bundle', $relation_types, 'IN');
    }
    $relation_ids = array_keys($query->execute());
    // Who knows why but field does not like if the delta does not start at 0...
    $items[$id] = array();
    foreach(entity_load('relation', $relation_ids) as $relation){
      $items[$id][] = (array)$relation;
    }
  }
}

function camelCaseToLabel($label){
  $label = preg_replace('/([a-z0-9])?([A-Z])/', '$1 $2', $label);
  $label = strtolower(preg_replace('/([a-z0-9])?([A-Z])/', '$1 $2', $label));
  $label = ucfirst(trim($label));
  return $label;
}