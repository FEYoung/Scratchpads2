<?php

/**
 * Implements hook_help().
 */
function scratchpad_relationt_help($path, $arg){
  if($path == 'admin/help#scratchpad_relation'){return t('Set ecological relationships.');}
}

/**
 * Implements hook_menu().
 */
function scratchpad_relations_menu(){
  $items = array();
  $items['admin/content/scratchpad_relations/%'] = array(
    'title' => 'Scratchpad relations',
    'description' => 'View, edit and delete any of the available relations on your site.',
    'page callback' => 'scratchpad_relations_admin_content',
    'page arguments' => array(
      3
    ),
    'access arguments' => array(
      'administer Scratchpad relations'
    ),
    'file' => 'scratchpad_relations.admin.inc',
    'type' => MENU_LOCAL_TASK
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function scratchpad_relations_theme($existing, $type, $theme, $path){
  $theme = array(
    'scratchpad_relations_admin_content' => array(
      'variables' => array(
        'relations' => NULL
      ),
      'file' => 'scratchpad_relations.admin.inc'
    ),
    'scratchpad_relation_field' => array(
      'variables' => array(
        'entity' => NULL,
        'relation' => NULL,
        'entity_type' => NULL,
        'items' => NULL,
        'related_entities' => NULL,
        'bundle' => NULL,
        'custom_title' => NULL,
        'field_name' => NULL,
        'list_type' => NULL
      ),
      'template' => 'scratchpad-relation-field',
      'path' => $path . '/theme'
    )
  );
  return $theme;
}

function scratchpad_relations_preprocess_scratchpad_relation_field(&$variables, $hook){
  $id = $variables['entity']->tid;
  $relation = $variables['relation'];
  $relation_type = relation_type_load($relation['relation_type']);
  if($variables['custom_title']){
    $label = $variables['custom_title'];
  }else{
    $label = $relation_type->directional ? $relation_type->reverse_label : $relation_type->label;
  }
  foreach($relation['endpoints'][LANGUAGE_NONE] as $endpoint){
    if($endpoint['entity_type'] == $variables['entity_type'] && $endpoint['entity_id'] == $id){
      if($endpoint['r_index'] == 0){
        $label = $relation_type->label;
      }
    }
  }
  $variables['items'] = array();
  foreach($variables['related_entities'] as $related_entity){
    $link = entity_uri($related_entity->entity_type, $related_entity);
    $variables['items'][] = $label . ' ' . l(entity_label($related_entity->entity_type, $related_entity), $link['path']);
  }
  $variables['theme_hook_suggestions'][] = 'scratchpad_relation_field__' . $variables['field_name'];
}

/**
 * Relation_add module was not formatting the endpoint lables correctly so override here
 * Implements hook_field_formatter_info().
 */
function scratchpad_relations_field_formatter_info(){
  return array(
    'relation_add_endpoints_and_fields' => array(
      'label' => t('Endpoints and fields'),
      'field types' => array(
        'relation_add'
      )
    )
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function scratchpad_relations_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display){
  $element = array();
  list($entity_id) = entity_extract_ids($entity_type, $entity);
  switch($display['type']){
    case 'relation_add_endpoints_and_fields':
      foreach($items as $delta => $item){
        $links = array();
        $relation = (object)$item;
        $related_entities = array();
        if(count($relation->endpoints[LANGUAGE_NONE]) > 1){
          foreach(array_filter($relation->endpoints[LANGUAGE_NONE]) as $endpoint){
            if($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $entity_id){
              continue;
            }
            // No link to the parent entity
            $related_entity = @reset(entity_load($endpoint['entity_type'], array(
              $endpoint['entity_id']
            )));
            $related_entity->entity_type = $endpoint['entity_type'];
            $related_entities[] = $related_entity;
            if(!($endpoint['entity_type'] == $entity_type && $endpoint['entity_id'] == $entity_id)){
              $link = entity_uri($endpoint['entity_type'], $related_entity);
              $link['href'] = $link['path'];
              $link['title'] = entity_label($endpoint['entity_type'], $related_entity);
              $links[] = $link;
            }
          }
          switch($instance['widget']['settings']['relation_endpoint_label']){
            case 'custom':
              $endpoint_title = t($instance['widget']['settings']['relation_endpoint_custom_label']);
              break;
          }
          $element[$delta]['relation'] = array(
            '#theme' => 'scratchpad_relation_field',
            '#related_entities' => $related_entities,
            '#entity_type' => $entity_type,
            '#bundle' => $instance['bundle'],
            '#entity' => $entity,
            '#custom_title' => $endpoint_title,
            '#field_name' => $instance['field_name'],
            '#relation' => $item
          );
        }
        $relation_view = relation_view($relation);
        $relation_instances = field_info_instances('relation', $relation->relation_type);
        foreach(array_keys($relation_instances) as $relation_field_name){
          if($relation_field_name !== 'endpoints'){
            if(isset($relation_view[$relation_field_name])){
              $element[$delta]['relation']['fields'][] = $relation_view[$relation_field_name];
            }
          }
        }
      }
      break;
  }
  return $element;
}
