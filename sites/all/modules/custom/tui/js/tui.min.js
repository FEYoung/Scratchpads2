(function(a){a.prototype.tui_goto=function(b){window.location.href=b};Drupal.tui=Drupal.tui||{};Drupal.tui.resize_frame=function(){window.setTimeout(function(){var b=150;if(a("#tui-tree-subcontainer ol").height()>(a(window).height()-b)){a("#tui-tree-subcontainer").css("height",(a(window).height()-b)+"px");a("#tui-tree-subcontainer").css("overflow-y","scroll")}else{a("#tui-tree-subcontainer").css("height","auto");a("#tui-tree-subcontainer").css("overflow-y","visible")}a("#tui-form").width(a("#tui").width()-(a("#tui-tree").width()+2))},100);window.setTimeout(function(){if(a(".tui-highlight").length){Drupal.tui.scrollto(a(".tui-highlight").first())}},200)};Drupal.tui.scrollto=function(b){a("#tui-tree-subcontainer").animate({scrollTop:a(b).position().top+a("#tui-tree-subcontainer").scrollTop()-50},500)};a(document).ready(function(){if(a(".tui-highlight").length==1){a(".tui-highlight").children("a").click()}if(a(".tui-highlight").length){Drupal.tui.scrollto(a(".tui-highlight").first())}Drupal.tui.resize_frame()});Drupal.behaviors.tui={attach:function(b,c){a("#tui",b).change(function(){Drupal.tui.resize_frame()});Drupal.ajax["tui-add-link"].beforeSend=function(e,d){if(a(".tui-highlight").length){if(d.dataType=="json"){d.data="tid="+a(".tui-highlight").first().parent().data("tui-this-term")+"&"+d.data}}};a("#edit-name",b).keyup(function(d){a("#tui-name-live h2").html(a("#edit-name").val())});Drupal.ajax["tui-add-link"].commands.insert=function(j,h,i){var e=h.selector?a(h.selector):a(j.wrapper);var d=h.method||j.method;var l=j.getEffect(h);var f=a("<div></div>").html(h.data);var k=f.contents();if(k.length!=1||k.get(0).nodeType!=1){k=f}switch(d){case"html":case"replaceWith":case"replaceAll":case"empty":case"remove":var g=h.settings||j.settings||Drupal.settings;Drupal.detachBehaviors(e,g)}e[d](k);if(l.showEffect!="show"){k.hide()}if(a(".ajax-new-content",k).length>0){a(".ajax-new-content",k).hide();k.show();a(".ajax-new-content",k)[l.showEffect](l.showSpeed)}else{if(l.showEffect!="show"){k[l.showEffect](l.showSpeed)}}if(k.parents("html").length>0){var g=h.settings||j.settings||Drupal.settings;Drupal.attachBehaviors(k,g)}Drupal.tui.resize_frame()};a("#tui-tree-links img",b).click(function(){switch(a(this).attr("id")){case"tui-delete":a("#tui-click").unbind("click");var e="";if(a(".tui-highlight").length){a(".tui-highlight").each(function(){if(e!=""){e+=","}e+=a(this).parent().data("tui-this-term")});a("#tui-tree-form").remove();a("#tui-tree-links").after('<div id="tui-tree-form"></div>');var d={};d.progress={type:"throbber"};d.url=a("#tui-delete").data("url")+e;d.event="click";Drupal.ajax["tui-click"]=new Drupal.ajax("tui-click",a("#tui-click"),d);a("#tui-click").click()}break;case"tui-search":a("#tui-click").unbind("click");a("#tui-tree-form").remove();a("#tui-tree-links").after('<div id="tui-tree-form"></div>');var d={};d.progress={type:"throbber"};d.url=a("#tui-search").data("url");d.event="click";Drupal.ajax["tui-click"]=new Drupal.ajax("tui-click",a("#tui-click"),d);a("#tui-click").click();break}});a("li.tui-has-children>div>span").unbind("click");a("li.tui-has-children>div>span").bind("click",function(d){if(a(this).parent().parent().hasClass("tui-closed")&&a(this).parent().parent().hasClass("tui-never-opened")){a(this).parent().parent().removeClass("tui-never-opened");a(this).parent().parent().removeClass("tui-closed");a(this).parent().parent().addClass("tui-load");var f=a(this);a.getJSON(Drupal.settings.tui.callback+"/"+a(this).parent().parent().data("tui-this-term"),function(e){f.parent().parent().children("ol").remove();f.parent().parent().append(e);Drupal.tui.resize_frame();f.parent().parent().removeClass("tui-load");f.parent().parent().addClass("tui-open");Drupal.attachBehaviors(a('li[data-tui-child-of="'+f.parent().parent().data("tui-this-term")+'"]').parent().parent());if(f.parent().hasClass("tui-highlight")){a("div",f.parent().parent()).addClass("tui-highlight")}})}else{if(!a(this).parent().parent().hasClass("tui-load")){a(this).parent().parent().toggleClass("tui-open");a(this).parent().parent().toggleClass("tui-closed");a(this).parent().next("ol").toggle();Drupal.tui.resize_frame()}}d.stopPropagation()});a("#tui-tree-subcontainer li>div").hover(function(){a(this).children(".edit-term-link").css("display","inline")},function(){a(this).children(".edit-term-link").css("display","none")});a("a.edit-term-link",b).click(function(){a(".tui-highlight").removeClass("tui-highlight");a(".tui-form-display").removeClass("tui-form-display");a(this).parent().addClass("tui-highlight tui-form-display");window.setTimeout(function(){Drupal.tui.resize_frame()},200)});a("#tui-tree",b).resizable({handles:"e",resize:function(d,e){a("#tui-form").width(a("#tui").width()-(a("#tui-tree").width()+2))},minWidth:250});a(window).resize(function(){Drupal.tui.resize_frame();a("#tui-form").width(a("#tui").width()-a("#tui-tree").width()-2)});a("#tui-tree",b).resize(function(){Drupal.tui.resize_frame()});a("#tui-tree-subcontainer li>div").click(function(){function d(e){a('li[data-tui-child-of="'+e+'"]').each(function(){a(this).children("div").each(function(){a(this).addClass("tui-highlight");d(a(this).parent().data("tui-this-term"))})})}a(".tui-highlight").removeClass("tui-highlight");a(this).addClass("tui-highlight");d(a(this).parent().data("tui-this-term"))});a("#tui-tree-subcontainer>ol").nestedSortable({cursorAt:{top:15},disableNesting:"no-nest",forcePlaceholderSize:true,handle:"div",helper:"clone",items:"li",opacity:0.8,placeholder:"placeholder",revert:250,tabSize:25,tolerance:"pointer",toleranceElement:"> div",update:function(g,h){if(a('li[data-tui-child-of="'+h.item.data("tui-child-of")+'"]').length==1){a('li[data-tui-this-term="'+h.item.data("tui-child-of")+'"]').removeClass("tui-open");a('li[data-tui-this-term="'+h.item.data("tui-child-of")+'"]').removeClass("tui-has-children");a('li[data-tui-this-term="'+h.item.data("tui-child-of")+'"]').addClass("tui-no-children")}if(h.item.parent().parent().data("tui-this-term")){h.item.attr("data-tui-child-of",h.item.parent().parent().data("tui-this-term"));h.item.data("tui-child-of",h.item.parent().parent().data("tui-this-term"))}else{h.item.removeAttr("data-tui-child-of");h.item.removeData("tui-child-of")}if(h.item.parent().parent().hasClass("tui-no-children")){h.item.parent().parent().removeClass("tui-no-children");h.item.parent().parent().addClass("tui-open");h.item.parent().parent().addClass("tui-has-children");Drupal.attachBehaviors(h.item.parent().parent().parent())}var e="";a(h.item).parent().children("li").each(function(){if(e!=""){e+=","}e+=a(this).data("tui-this-term")});var d={parent_change:{tid:h.item.data("tui-this-term"),parent:h.item.data("tui-child-of")},sort_change:{tids:e}};var f=a(this);a.ajax({data:d,type:"POST",url:Drupal.settings.tui.sort_callback,success:function(l,m,k){if(typeof l=="string"){l=a.parseJSON(l)}for(var j in l){if(l[j]["command"]){if(l[j]["command"]=="settings"){if(l.merge){a.extend(true,Drupal.settings,l.settings)}}}}},error:function(j,k,i){f.nestedSortable("cancel");a("#tui-tree-form").html('<div class="messages error"><h2 class="element-invisible">Error message</h2>'+Drupal.t("There has been an error.  Please reload this page.")+"</div>").slideDown()}})}})}}})(jQuery);