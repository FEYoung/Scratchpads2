<?php

/**
 * Implementation of hook_menu().
 */
function gm3_country_menu(){
  return array(
    'gm3_country/callback' => array(
      'title' => 'GM3 Country callback',
      'page callback' => 'gm3_country_get_points',
      'file' => 'gm3_country.callback.inc',
      'access arguments' => array(
        'access content'
      ),
      'type' => MENU_CALLBACK
    )
  );
}

/**
 * Implementation of hook_library().
 * 
 * FIXME - Select countries.  Click on a country could bring up an option to 
 * select the subregions (TDWG 4).
 */
function gm3_country_library(){
  // Whether or not to use the minified versions of the code.
  $min = variable_get('gm3_use_minified', false) ? '.min' : '';
  return array(
    // Enable the clicking of countries.
    'country' => array(
      'title' => t('Google Maps Javascript API V3: Country selection'),
      'website' => 'http://code.google.com/apis/maps/',
      'version' => '3',
      'js' => array(
        array(
          'data' => drupal_get_path('module', 'gm3_country') . "/js/gm3.country$min.js"
        )
      ),
      'dependencies' => array(
        array(
          'gm3',
          'gm3'
        ),
        array(
          'gm3',
          'gm3.polygon'
        )
      )
    )
  );
}

/**
 * Implementation of hook_theme().
 */
function gm3_country_theme(){
  return array(
    'gm3_country_country_button' => array(
      'variables' => array(
        'id' => 'gm3-map'
      ),
      'file' => 'gm3_country.theme.inc'
    )
  );
}

/**
 * Implementation of hook_gm3_settings_alter().
 */
function gm3_country_gm3_map_alter(&$map){
  
  // TESTING - Get some country data.
  module_load_include('callback.inc', 'gm3_country');
  $result = db_select('gm3_country_data', 'g')->condition('iso_code', 'CH')->fields('g')->execute();
  foreach($result as $something){
    foreach(gm3_country_convert_string($something->polygons) as $polygon){
      $map['libraries']['polygon']['polygons'][] = $polygon;
    }
  }
  
  if(isset($map['libraries'])){
    foreach($map['libraries'] as $id => $library){
      $library_name = $library;
      if(is_array($library)){
        $library_name = $id;
      }
      switch($library_name){
        case 'country':
          $map['tools'][] = theme('gm3_country_country_button', array(
            'id' => $map['id']
          ));
          break;
        default:
          break;
      }
    }
  }
}