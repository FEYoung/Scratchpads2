<?php

/**
 * @file
 * 
 * Provides three additional hooks:
 * 
 * hook_tcsdc_form()
 * hook_tcsdc_help()
 * hook_tcsdc_data_alter()
 */
/**
 * Implementation of hook_menu().
 */
function tcsdc_menu(){
  return array(
    'admin/structure/taxonomy/tcs-import' => array(
      'title' => 'TCS Import',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'tcsdc_primary_form'
      ),
      'access arguments' => array(
        'administer taxonomy'
      )
    ) // 'file' => 'tcsdc.form.inc'
  );
}

/**
 * Form definition, as used by the form flow.
 */
function tcsdc_primary_form($form, &$form_state){
  // First, we need to get the TCS form definitions from the respective modules.
  // We do this by getting the tcsdc defintions and looping through each.
  $form = module_invoke_all('tcsdc_form', $form, $form_state);
  return array_merge($form, array(
    '#submit' => array(
      'tcsdc_primary_form_submit'
    )
  ));
}

/**
 * Helper function for setting variables that need to be accessed in different
 * functions.
 */
function tcsdc_variable($name, $value = NULL){
  static $data = array();
  if(!is_null($value)){
    $data[$name] = $value;
  }
  return $data[$name];
}

/**
 * Batch downloader.  This does the recursive downloading of the XML.  The XML
 * is converted and saved in the database, eventually to be output as CSV.
 */
function tcsdc_batch_downloader($urls, $total = 1000000, &$context){
  if(!isset($context['sandbox']['progress'])){
    $context['sandbox']['progress'] = 0;
    $context['sandbox']['max'] = $total;
    $context['sandbox']['originalurl'] = $urls[0];
    $context['sandbox']['urls'] = $urls;
    // Set a static array for the URLs, this means that we can alter it when
    // parsing the XML.
    tcsdc_variable('tcsdc_urls', $urls);
  }
  $batch = &batch_get();
  $url = array_shift($context['sandbox']['urls']);
  tcsdc_variable('tcsdc_urls', $context['sandbox']['urls']);
  tcsdc_batch_downloader_helper($url);
  $context['sandbox']['urls'] = tcsdc_variable('tcsdc_urls');
  // Get the number of names we have downloaded.
  $num_names_saved = db_query("SELECT COUNT(*) FROM {tcsdc_data} WHERE bid = ?", array(
    $batch['id']
  ))->fetchField();
  $context['sandbox']['progress'] = $num_names_saved / $context['sandbox']['max'];
  // Set the message
  $context['message'] = t('Downloaded %numnames names of approximately %totalnames', array(
    '%numnames' => $num_names_saved,
    '%totalnames' => $context['sandbox']['max']
  ));
  // Inform the batch engine that we are not finished,
  // and provide an estimation of the completion level we reached.
  if(count($context['sandbox']['urls'])){
    if($context['sandbox']['progress'] < 1){
      $context['finished'] = $context['sandbox']['progress'];
    }else{
      $context['finished'] = 0.95;
    }
  }else{
    $context['finished'] = 1;
  }
   // Remove following line after debugging.
//$context['finished'] = 1;
}

/**
 * Helper for the above function
 */
function tcsdc_batch_downloader_helper($url){
  dpm($url);
  $xml = new SimpleXMLElement($url, 0, TRUE);
  foreach($xml->TaxonNames->TaxonName as $name){
    // Lets save the data to the table so that we can extract it later.
    // Get the type of this element.  If it is a vernacular of synonym, we
    // should have a record of it (for parentage).
    
    $data = array(
      'simple' => (string)$name->Simple,
      'rank' => (string)$name->Rank,
      'canonicalname' => (string)$name->CanonicalName->Simple
    );
    dpm($data);
  }
  foreach($xml->TaxonConcepts->TaxonConcept->TaxonRelationships->TaxonRelationship as $relationship){
    switch((string)$relationship['type']){
      case 'has synonym':
        // Add the URL to the list to download, and also add to the list of
        // synonyms (referencing this name).
        // URLs
        $urls = tcsdc_variable('tcsdc_urls');
        $urls[] = (string)$relationship->ToTaxonConcept['ref'];
        tcsdc_variable('tcsdc_urls', $urls);
        // Synonyms
        $urls = tcsdc_variable('tcsdc_synonyms');
        $urls[] = (string)$relationship->ToTaxonConcept['ref'];
        tcsdc_variable('tcsdc_synonyms', $urls);
        break;
      case 'has vernacular':
        // Add the URL to the list to download, and also add to the list of 
        // vernacular names (referencing this name).
        // URLs
        $urls = tcsdc_variable('tcsdc_urls');
        $urls[] = (string)$relationship->ToTaxonConcept['ref'];
        tcsdc_variable('tcsdc_urls', $urls);
        // Vernaculars
        $urls = tcsdc_variable('tcsdc_vernaculars');
        $urls[] = (string)$relationship->ToTaxonConcept['ref'];
        tcsdc_variable('tcsdc_vernaculars', $urls);
        break;
      default:
        //dpm((string)$relationship['type']);
        break;
    }
  }
}