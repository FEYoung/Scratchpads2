<?php

/**
 * @file
 * 
 * Simple module that allows a user to select when entities/fields should be
 * used to autotag an entity.  This currently supports:
 * 
 * - node/all fields
 * ...
 * 
 * The module allows a user to specify the search module to use, and where the
 * resulting terms should be saved.  The following entities are supported out of
 * the box:
 * - comment
 * - node
 * - user
 */
/**
 * Implementation of hook_form_FORM_ID_alter().
 */
function tagtag_form_node_type_form_alter(&$form, &$form_state, $form_id){
  // Get the list of search services for the form.
  $search_services = module_invoke_all('tag_suggestion_info');
  $options = array();
  $options_forms = array();
  foreach($search_services as $key => $search_service){
    $options[$key] = $search_service['label'];
    if(isset($search_service['options']) && function_exists($search_service['options'])){
      $options_forms[$key] = $search_service['options']($form['#node_type']->type);
    }
  }
  // Get a list of front end services that will enable us to interact with
  // the data.
  $ui_services = module_invoke_all('tag_ui_info');
  $ui_options = array();
  $ui_options_forms = array();
  foreach($ui_services as $key => $ui_service){
    $ui_options[$key] = $ui_service['label'];
    if(isset($ui_service['options']) && function_exists($ui_service['options'])){
      $ui_options_forms[$key] = $ui_service['options']($form['#node_type']->type);
    }
  }
  // Get a list of fields that this data can be saved to
  $field_options = array(
    0 => '-- Select --'
  );
  $instances = field_info_instances('node', $form['#node_type']->type);
  foreach($instances as $key => $instance){
    $field_options[$key] = $instance['label'];
  }
  // Form
  $form['tagtag'] = array(
    '#type' => 'fieldset',
    '#title' => t('Tag options'),
    '#group' => 'additional_settings',
    'tagtag_search' => array(
      '#default_value' => variable_get('tagtag_search_' . $form['#node_type']->type, array()),
      '#title' => t('Search services'),
      '#type' => 'checkboxes',
      '#options' => $options,
      '#description' => t('Select the search services you would like to use to provide tags to this content type.  Additional options for each search service will be displayed below.')
    ),
    'tagtag_field' => array(
      '#required' => TRUE,
      '#title' => t('Field to populate'),
      '#default_value' => variable_get('tagtag_field_' . $form['#node_type']->type, ''),
      '#type' => 'select',
      '#options' => $field_options,
      '#description' => t('Please select the field you would like tags saving to.  Note, all content in the field will be replaced by tag data.')
    )
  );
  // Additional settings for each module - hopefully hidden if the search
  // isn't selected.
  foreach($options_forms as $key => $options_form){
    $form['tagtag'][$key] = $options_form;
    $form['tagtag'][$key]['#type'] = 'fieldset';
    $form['tagtag'][$key]['#title'] = $options[$key];
    $form['tagtag'][$key]['#states'] = array(
      'visible' => array(
        ':input[name="tagtag_search[' . $key . ']"]' => array(
          'checked' => TRUE
        )
      )
    );
  }
  $form['#validate'][] = 'tagtag_node_type_form_validate';
}

/**
 * Callback for the above to validate the form
 */
function tagtag_node_type_form_validate($form, &$form_state){
  // Simply check that a field has been selected ONLY if a search method has
  // been specified.
  foreach($form_state['input']['tagtag_search'] as $key => $value){
    if($value && !$form_state['input']['tagtag_field']){
      // We've selected a search, but not a field.
      form_set_error('tagtag_field', t('Please select a field to save tags to'));
    }
  }
}