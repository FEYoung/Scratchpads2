<?php

/**
 * Indexer for the userhook_apachesolr_entity_info_alter entities for the Apachesolr module.
 */
function apachesolr_file_apachesolr_entity_info_alter(&$entity_info){
  $entity_info['file']['indexable'] = TRUE;
  $entity_info['file']['status callback'] = 'apachesolr_file_status_callback';
  $entity_info['file']['document callback'][] = 'apachesolr_file_solr_document';
  $entity_info['file']['reindex callback'] = 'apachesolr_file_solr_reindex';
  $entity_info['file']['index_table'] = 'apachesolr_index_entities';
}

/**
 * Apachesolr: status callback
 */
function apachesolr_file_status_callback($file, $type){
  return TRUE;
}

/**
 * Apachesolr: document callback
 *
 * @param ApacheSolrDocument $document
 * The Solr document we are building up.
 * @param stdClass $entity
 * The entity we are indexing.
 * @param string $entity_type
 * The type of entity we're dealing with.
 */
function apachesolr_file_solr_document(ApacheSolrDocument $document, $file, $entity_type){
  $document->fid = $file->fid;
  // Title is a required field.
  $document->label = apachesolr_clean_text($file->filename);
  $build = file_view($file, 'search_index');
  // Why do we need this?
  unset($build['#theme']);
  $text = drupal_render($build);
  $document->content = apachesolr_clean_text($text);
  //  Generic usecase for future reference. Callbacks can
  //  allow you to send back multiple documents
  $documents = array();
  $documents[] = $document;
  return $documents;
}

/**
 * Apachesolr: reindex callback
 */
function apachesolr_file_solr_reindex(){
  $indexer_table = apachesolr_get_indexer_table('file');
  $transaction = db_transaction();
  $env_id = apachesolr_default_environment();
  try{
    // FIXME - This needs to be a little more intelligent I suspect.
    db_delete($indexer_table)->condition('entity_type', 'file')->execute();
    $select = db_select('file_managed', 'f');
    $select->addField('f', 'fid', 'entity_id');
    $select->addField('f', 'type', 'bundle');
    $select->addField('f', 'status', 'status');
    //$select->addField('f', '`timestamp`', 'changed');
    $select->addExpression(REQUEST_TIME, 'changed');
    $select->addExpression("'file'", 'entity_type');
    $select->condition('f.type', apachesolr_get_index_bundles($env_id, 'file'), 'IN');
    $insert = db_insert($indexer_table)->fields(array(
      'entity_id',
      'bundle',
      'status',
      'changed',
      'entity_type'
    ))->from($select)->execute();
  }
  catch(Exception $e){
    $transaction->rollback();
    watchdog_exception('Apache Solr', $e);
    return FALSE;
  }
  return TRUE;
}