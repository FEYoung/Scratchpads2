<?php

/**
 * @file
 * 
 * This module defines one new hook - hook_silver_info().  The hook allows other
 * modules to include their import forms on the silver import page.
 */
/**
 * Implementation of hook_menu().
 */
function silver_menu(){
  return array(
    'i' => array(
      'title' => 'Import',
      'description' => 'Import data into your web site',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'silver_import_form'
      ),
      'access callback' => 'silver_access_callback'
    )
  );
}

/**
 * Implementation of hook_silver().
 * 
 * * type
 * * name
 * * access arguments
 * * file
 * * form_id
 */
function silver_silver(){
  // Here we tell ourselves about the Feeds module forms, and suck like.
  return array(
    array(
      'type' => 'Pages',
      'name' => 'Excel file import',
      //'access callback' => 'user_access',
      'access arguments' => array(
        'administer taxonomy' // FIXME
      ),
      'file' => 'silver_pages_excel.inc',
      'form_id' => 'silver_pages_excel_form'
    ),
    array(
      'type' => 'Taxonomy',
      'name' => 'Excel file import',
      //'access callback' => 'user_access',
      'access arguments' => array(
        'administer taxonomy'
      ),
      'file' => 'silver_taxonomy_excel.inc',
      'form_id' => 'silver_taxonomy_excel_form'
    )
  );
}

/**
 * If one import method that supports silver allows access to this user, then
 * we allow the user to view the form.
 */
function silver_access_callback(){
  // Note, this function conveniently loads all the required files for us,
  // which means the submit functions should work as expected.
  return count(silver_get_silvers());
}

/**
 * Get an array of the silvers we can access
 */
function silver_get_silvers(){
  $silvers_we_can_access = array();
  $modules = module_implements('silver');
  foreach($modules as $module){
    $silvers = call_user_func($module . '_silver');
    foreach($silvers as $info){
      // Include the file
      if(isset($info['file'])){
        require_once (drupal_get_path('module', $module) . '/' . $info['file']);
      }
      $callback = isset($info['access callback']) ? $info['access callback'] : 'user_access';
      if(call_user_func_array($callback, $info['access arguments'])){
        $info['module'] = $module;
        $silvers_we_can_access[] = $info;
      }
    }
  }
  usort($silvers_we_can_access, 'silvers_array_sort');
  return $silvers_we_can_access;
}

/**
 * Usort callback.
 */
function silvers_array_sort($a, $b){
  $type_diff = strcmp($a['type'], $b['type']);
  if($type_diff !== 0){return $type_diff;}
  return strcmp($a['name'], $b['name']);
}

/**
 * Implementation of hook_theme().
 */
function silver_theme(){
  return array(
    'silver_import_form' => array(
      'render element' => 'form'
    )
  );
}

/**
 * Form
 */
function silver_import_form(){
  // Get the info from the other modules that support "silver".
  $modules = module_implements('silver');
  $infos = array();
  $form = array();
  $options = array(
    0 => t('- Select import -')
  );
  $i = 1;
  $silvers = silver_get_silvers();
  $submit_function_names = array();
  foreach($silvers as $info){
    $callback = isset($info['access callback']) ? $info['access callback'] : 'user_access';
    if(!call_user_func_array($callback, $info['access arguments'])){
      continue;
    }
    if(!isset($options[$info['type']])){
      $options[$info['type']] = array();
    }
    $options[$info['type']][$i] = $info['name'];
    $subform_state = array(
      'build_info' => array(
        'args' => array()
      ),
      'method' => 'post'
    );
    $subform = drupal_retrieve_form($info['form_id'], $subform_state);
    drupal_prepare_form($info['form_id'], $subform, $subform_state);
    // We need to remove additional crap from the subform, to ensure that it
    // doesn't actually get rendered as a form.  Note, we're doing this to
    // ensure that other modules have the opportunity to alter the individual
    // forms.
    foreach(element_properties($subform) as $key){
      unset($subform[$key]);
    }
    $form[$info['module'] . '_' . $i] = array(
      '#type' => 'fieldset',
      '#title' => $info['type'] . ' :: ' . $info['name'],
      '#states' => array(
        'visible' => array(
          ':input[name="silver_import_select"]' => array(
            'value' => "$i"
          )
        )
      ),
      'subform' => $subform
    );
    $i++;
  }
  $form['#method'] = 'post';
  $form['silver_import_select'] = array(
    '#weight' => -100,
    '#type' => 'select',
    '#title' => '',
    '#options' => $options
  );
  return $form;
}

/**
 * Theme function for the above form.
 */
function theme_silver_import_form($variables){
  drupal_add_css(drupal_get_path('module', 'silver') . '/css/silver.css');
  $children = element_children($variables['form'], TRUE);
  $output = '';
  foreach($children as $child){
    $output = drupal_render($child);
  }
  return $output;
}