<?php

/**
 * @file
 * 
 * This module defines one new hook - hook_silver_info().  The hook allows other
 * modules to include their import forms on the silver import page.
 */
/**
 * Implementation of hook_menu().
 */
function silver_menu(){
  return array(
    'i' => array(
      'title' => 'Import',
      'description' => 'Import data into your web site',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'silver_import_form'
      ),
      'access callback' => 'silver_access_callback'
    )
  );
}

/**
 * Implementation of hook_silver().
 */
function silver_silver(){
  // Here we tell ourselves about the Feeds module forms, and suck like.
  return array(
    'type' => 'Taxonomy',
    'name' => 'Taxon Concept Schema Import',
    //'access callback' => 'user_access',
    'access arguments' => array(
      'administer taxonomy'
    ),
    'form_id' => 'tcsdc_primary_form'
  );
}

/**
 * If one import method that supports silver allows access to this user, then
 * we allow the user to view the form.
 */
function silver_access_callback(){
  $modules = module_implements('silver');
  foreach($modules as $module){
    $silvers = call_user_func($module . '_silver');
    foreach($silvers as $info){
      $callback = isset($info['access callback']) ? $info['access callback'] : 'user_access';
      if(call_user_func_array($callback, $info['access arguments'])){return TRUE;}
    }
  }
  return FALSE;
}

/**
 * Implementation of hook_theme().
 */
function silver_theme(){
  return array(
    'silver_import_form' => array(
      'render element' => 'form'
    )
  );
}

/**
 * Form
 */
function silver_import_form(){
  // Get the info from the other modules that support "silver".
  $modules = module_implements('silver');
  $infos = array();
  $form = array();
  $options = array(
    0 => t('- Select import -')
  );
  $i = 1;
  foreach($modules as $module){
    $silvers = call_user_func($module . '_silver');
    foreach($silvers as $info){
      $callback = isset($info['access callback']) ? $info['access callback'] : 'user_access';
      if(!call_user_func_array($callback, $info['access arguments'])){
        continue;
      }
      if(!isset($options[$info['type']])){
        $options[$info['type']] = array();
      }
      $options[$info['type']][$i] = $info['name'];
      if(isset($info['file'])){
        $file = DRUPAL_ROOT . '/' . drupal_get_path('module', $module) . "/" . $info['file'];
        if(is_file($file)){
          require_once $file;
        }
      }
      $subform_state = array(
        'build_info' => array(
          'args' => array()
        ),
        'method' => 'get'
      );
      $subform = drupal_retrieve_form($info['form_id'], $subform_state);
      drupal_prepare_form($info['form_id'], $subform, $subform_state);
      $form[$module] = array(
        '#type' => 'fieldset',
        '#title' => $info['name'],
        '#states' => array(
          'visible' => array(
            ':input[name="silver_import_select"]' => array(
              'value' => "$i"
            )
          )
        ),
        'subform' => $subform
      );
      $i++;
    }
  }
  $form['silver_import_select'] = array(
    '#weight' => -100,
    '#type' => 'select',
    '#title' => '',
    '#options' => $options
  );
  return $form;
}

/**
 * Theme function for the above form.
 */
function theme_silver_import_form($variables){
  drupal_add_css(drupal_get_path('module', 'silver') . '/css/silver.css');
  $children = element_children($variables['form'], TRUE);
  $output = '';
  foreach($children as $child){
    $output = drupal_render($child);
  }
  return $output;
}